<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
{% load static %}
  <link rel="icon" type="image/png" href="{% static 'images/unnamed.png' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <title>SQL Query Interface</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #0a0e27; color: #e4e4e7; min-height: 100vh; }
    
    .sidebar { position: fixed; left: 0; top: 0; width: 260px; height: 100vh; background: #0f1629; border-right: 1px solid #1e293b; padding: 24px 0; z-index: 100; }
    .sidebar-header { padding: 0 24px 24px; border-bottom: 1px solid #1e293b; }
    .logo { font-size: 24px; font-weight: 800; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-menu { margin-top: 24px; padding: 0 12px; }
    .nav-item { list-style: none; margin-bottom: 4px; }
    .nav-link { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: #94a3b8; text-decoration: none; border-radius: 8px; font-size: 14px; font-weight: 500; transition: all 0.2s ease; }
    .nav-link:hover, .nav-link.active { background: rgba(102, 126, 234, 0.1); color: #667eea; }
    .nav-link i { width: 20px; font-size: 18px; }
    
    .main-content { margin-left: 260px; padding: 24px; min-height: 100vh; }
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .page-title { font-size: 28px; font-weight: 700; color: #f1f5f9; }
    .btn-primary { padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; text-decoration: none; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    
    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; display: flex; align-items: center; gap: 10px; }
    .alert-success { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
    .alert-danger { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
    .alert-info { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
    
    .query-section { background: linear-gradient(135deg, #1e293b 0%, #0f1629 100%); border: 1px solid #334155; border-radius: 12px; padding: 24px; margin-bottom: 28px; }
    .section-header { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; font-size: 18px; font-weight: 700; color: #f1f5f9; }
    
    .query-input-group { margin-bottom: 20px; }
    .query-label { display: block; font-size: 13px; font-weight: 600; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .query-textarea { width: 100%; min-height: 200px; padding: 16px; background: #0f1629; border: 1px solid #334155; border-radius: 8px; color: #e4e4e7; font-family: 'Courier New', monospace; font-size: 22px; resize: vertical; }
    .query-textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
    
    .query-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .btn-execute { padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
    .btn-execute:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    .btn-clear { padding: 12px 24px; background: #334155; border: 1px solid #475569; border-radius: 8px; color: #94a3b8; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; }
    .btn-clear:hover { background: #475569; color: #e4e4e7; }
    
    .btn-export { padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
    .btn-export:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4); }
    .btn-export:disabled { opacity: 0.5; cursor: not-allowed; background: #334155; }
    
    .query-examples { background: rgba(102, 126, 234, 0.05); border: 1px solid rgba(102, 126, 234, 0.2); border-radius: 8px; padding: 16px; margin-top: 20px; }
    .examples-title { font-size: 13px; font-weight: 600; color: #94a3b8; margin-bottom: 10px; }
    .example-query { background: #0f1629; border: 1px solid #334155; border-radius: 6px; padding: 10px 12px; margin-bottom: 8px; font-family: 'Courier New', monospace; font-size: 12px; color: #94a3b8; cursor: pointer; transition: all 0.2s ease; }
    .example-query:hover { border-color: #667eea; color: #667eea; }
    
    .results-section { background: linear-gradient(135deg, #1e293b 0%, #0f1629 100%); border: 1px solid #334155; border-radius: 12px; padding: 24px; margin-bottom: 28px; }
    .results-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .results-title { font-size: 18px; font-weight: 700; color: #f1f5f9; display: flex; align-items: center; gap: 8px; }
    .row-count { font-size: 14px; color: #94a3b8; font-weight: 500; }
    
    .table-wrapper { overflow-x: auto; }
    .data-table { width: 100%; border-collapse: collapse; min-width: 600px; }
    .data-table thead { border-bottom: 1px solid #334155; position: sticky; top: 0; background: #1e293b; }
    .data-table th { text-align: left; padding: 12px; font-size: 12px; font-weight: 600; color: #94a3b8; text-transform: uppercase; white-space: nowrap; }
    .data-table td { padding: 14px 12px; font-size: 14px; color: #e4e4e7; border-bottom: 1px solid #1e293b; }
    .data-table tbody tr:hover { background: rgba(102, 126, 234, 0.05); }
    
    .no-results { text-align: center; padding: 60px 20px; color: #94a3b8; }
    .no-results i { font-size: 48px; margin-bottom: 16px; color: #475569; }
    .no-results p { font-size: 16px; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header"><div class="logo">YR Sales</div></div>
    <nav class="nav-menu">
      <ul>
        <li class="nav-item"><a href="{% url 'sales_dashboard' %}" class="nav-link"><i class="fas fa-chart-line"></i><span>Dashboard</span></a></li>
        <li class="nav-item"><a href="{% url 'another' %}" class="nav-link"><i class="fas fa-bullseye"></i><span>Plan vs Actual</span></a></li>
        <li class="nav-item"><a href="{% url 'query' %}" class="nav-link active"><i class="fas fa-search"></i><span>Query</span></a></li>
        <li class="nav-item"><a href="{% url 'employee_analytics' %}" class="nav-link"><i class="fas fa-users"></i><span>Employee Analytics</span></a></li>
        <li class="nav-item"><a href="{% url 'insights' %}" class="nav-link"><i class="fas fa-lightbulb"></i><span>Insights</span></a></li>
      </ul>
    </nav>
  </aside>

  <main class="main-content">
    <div class="top-bar">
      <h1 class="page-title"><i class="fas fa-database"></i> SQL Query Interface</h1>
      <a href="{% url 'sales_dashboard' %}" class="btn-primary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </a>
    </div>
 <div style="background: linear-gradient(135deg, #1e293b 0%, #0f1629 100%); border: 1px solid #334155; border-radius: 12px; padding: 16px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
  <div style="display: flex; align-items: center; gap: 12px;">
    <div style="width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; background: rgba(102, 126, 234, 0.15); color: #667eea;">
      <i class="fas fa-user"></i>
    </div>
    <div>
      <div style="font-size: 14px; font-weight: 600; color: #f1f5f9;">{{ request.user.username }}</div>
      <div style="font-size: 12px; color: #94a3b8;">
        {% if is_admin %}
          <i class="fas fa-crown" style="color: #fb923c;"></i> Administrator - Full Access
        {% else %}
          <i class="fas fa-map-marker-alt"></i> Access to {{ user_locations_count }} location{{ user_locations_count|pluralize }}
        {% endif %}
      </div>
    </div>
  </div>
  <a href="{% url 'logout' %}" class="btn-primary" style="background: rgba(239, 68, 68, 0.2); color: #ef4444;">
    <i class="fas fa-sign-out-alt"></i> Logout
  </a>
</div>
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    {% if error_message %}
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i>
        {{ error_message }}
      </div>
    {% endif %}

    <div class="query-section">
      <div class="section-header">
        <i class="fas fa-code"></i> Write Your SQL Query
      </div>
      
      <form method="POST" id="queryForm">
        {% csrf_token %}
        <div class="query-input-group">
          <label class="query-label" for="sql_query">SQL Query (SELECT only)</label>
          <textarea 
            class="query-textarea" 
            id="sql_query" 
            name="sql_query" 
            placeholder="SELECT * FROM sales_main_web LIMIT 10;"
            required>{{ query_text }}</textarea>
        </div>
        
        <div class="query-actions">
          <button type="submit" class="btn-execute">
            <i class="fas fa-play"></i> Execute Query
          </button>
          <button type="button" class="btn-clear" onclick="clearQuery()">
            <i class="fas fa-eraser"></i> Clear
          </button>
        </div>
      </form>

      <form method="POST" style="display: inline;" id="exportForm">
        {% csrf_token %}
        <input type="hidden" name="sql_query" id="export_sql_query" value="{{ query_text }}">
        <input type="hidden" name="export_excel" value="1">
        <div class="query-actions" style="margin-top: 12px;">
          <button type="submit" class="btn-export" {% if not results %}disabled{% endif %}>
            <i class="fas fa-file-excel"></i> Export to Excel
          </button>
        </div>
      </form>

      <div class="query-examples">
  <div class="examples-title"><i class="fas fa-lightbulb"></i> Example Queries (click to use):</div>
  
  <div class="example-query" onclick="setQuery('WITH cte_base AS (&#10;  SELECT * FROM sales_main_web&#10;  WHERE &quot;Tanxa&quot; &lt;&gt; 0 AND EXTRACT(YEAR FROM &quot;CD&quot;) = 2026 AND EXTRACT(MONTH FROM &quot;CD&quot;) = 1&#10;),&#10;cte_metrics AS (&#10;  SELECT&#10;    &quot;UN&quot;,&#10;    &quot;Tanam&quot;,&#10;    SUM(&quot;Tanxa&quot;) AS total_turnover,&#10;    SUM(CASE WHEN &quot;ProdG&quot; = &#39;SKIN CARE&#39; THEN &quot;Tanxa&quot; ELSE 0 END) AS skincare_turnover,&#10;    SUM(CASE WHEN &quot;ProdG&quot; = &#39;SKIN CARE&#39; THEN &quot;Tanxa&quot; ELSE 0 END) /&#10;    NULLIF(SUM(CASE WHEN &quot;ProdG&quot; = &#39;POP&#39; THEN 0 ELSE &quot;Tanxa&quot; END), 0) AS skincare_pct&#10;  FROM cte_base&#10;  GROUP BY &quot;UN&quot;, &quot;Tanam&quot;&#10;),&#10;cte_cross_selling AS (&#10;  SELECT&#10;    &quot;UN&quot;,&#10;    &quot;Tanam&quot;,&#10;    &quot;Zedd&quot;,&#10;    COUNT(*) AS items_in_basket&#10;  FROM cte_base&#10;  WHERE &quot;ProdG&quot; NOT IN (&#39;POP&#39;, &#39;SERVICE&#39;, &#39;GIFT CARD&#39;) AND &quot;Tanxa&quot; &lt;&gt; 0&#10;  GROUP BY &quot;UN&quot;, &quot;Tanam&quot;, &quot;Zedd&quot;&#10;),&#10;cte_cross_main AS (&#10;  SELECT&#10;    &quot;UN&quot;,&#10;    &quot;Tanam&quot;,&#10;    SUM(CASE WHEN items_in_basket &gt;= 3 THEN 1.0 ELSE 0 END) AS cross_selling_count_more_than_three,&#10;    COUNT(*) AS total_unique_transactions,&#10;    SUM(CASE WHEN items_in_basket &gt;= 3 THEN 1.0 ELSE 0 END) / COUNT(*) AS cross_selling_percentage_more_than_three&#10;  FROM cte_cross_selling&#10;  GROUP BY &quot;UN&quot;, &quot;Tanam&quot;&#10;)&#10;SELECT&#10;    m.&quot;UN&quot;,&#10;    m.&quot;Tanam&quot;,&#10;    m.total_turnover,&#10;    m.skincare_pct,&#10;    m.skincare_turnover,&#10;    c.cross_selling_percentage_more_than_three,&#10;    c.cross_selling_count_more_than_three,&#10;    c.total_unique_transactions&#10;FROM cte_metrics m&#10;LEFT JOIN cte_cross_main c ON m.&quot;UN&quot; = c.&quot;UN&quot; AND m.&quot;Tanam&quot; = c.&quot;Tanam&quot;&#10;ORDER BY m.skincare_pct DESC, c.cross_selling_percentage_more_than_three DESC;')">
    <strong>BONUS:</strong> Employee skincare & cross-selling analysis (Jan 2026)
  </div>

  <div class="example-query" onclick="setQuery('SELECT &quot;UN&quot;, &quot;Tanam&quot;, ROUND(CAST(SUM(&quot;Tanxa&quot;) AS INT), 2) FROM sales_main_web WHERE EXTRACT(YEAR FROM &quot;CD&quot;) = 2025 GROUP BY &quot;UN&quot;, &quot;Tanam&quot; ORDER BY SUM(&quot;Tanxa&quot;) DESC;')">
    Employee sales totals for 2025
  </div>
  
  <div class="example-query" onclick="setQuery('SELECT &quot;UN&quot;, COUNT(*) as Order_Count, SUM(&quot;Tanxa&quot;) as Total_Amount FROM sales_main_web GROUP BY &quot;UN&quot; ORDER BY Total_Amount DESC;')">
    Order count and total amount by employee
  </div>
  
  <div class="example-query" onclick="setQuery('SELECT &quot;Actions&quot;, AVG(&quot;Tanxa&quot;) as Avg_Price, COUNT(*) as Count FROM sales_main_web WHERE &quot;Actions&quot; IS NOT NULL GROUP BY &quot;Actions&quot;;')">
    Average price and count by action type
  </div>
  
  <div class="example-query" onclick="setQuery('SELECT * FROM sales_main_web LIMIT 10;')">
    Show first 10 records
  </div>
</div>

    {% if results is not None %}
    <div class="results-section">
      <div class="results-header">
        <div class="results-title">
          <i class="fas fa-table"></i> Query Results
        </div>
        {% if results %}
          <span class="row-count">{{ results|length }} row{{ results|length|pluralize }}</span>
        {% endif %}
      </div>

      {% if results %}
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                {% for column in columns %}
                  <th>{{ column }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for row in results %}
                <tr>
                  {% for value in row %}
                    <td>{{ value|default:"-" }}</td>
                  {% endfor %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="no-results">
          <i class="fas fa-inbox"></i>
          <p>No results found</p>
        </div>
      {% endif %}
    </div>
    {% endif %}

  </main>

  <script>
     function setQuery(query) {
      // Decode HTML entities using DOMParser
      const parser = new DOMParser();
      const decoded = parser.parseFromString(query, 'text/html').body.textContent;
      
      document.getElementById('sql_query').value = decoded;
      document.getElementById('sql_query').focus();
      
      // Trigger auto-resize
      const textarea = document.getElementById('sql_query');
      textarea.style.height = 'auto';
      textarea.style.height = Math.max(200, textarea.scrollHeight) + 'px';
    }

    function clearQuery() {
      document.getElementById('sql_query').value = '';
      document.getElementById('sql_query').focus();
    }

    // Sync query text to export form
    document.getElementById('queryForm').addEventListener('submit', function() {
      document.getElementById('export_sql_query').value = document.getElementById('sql_query').value;
    });

    // Auto-resize textarea
    const textarea = document.getElementById('sql_query');
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.max(200, this.scrollHeight) + 'px';
    });
  </script>
</body>
</html>